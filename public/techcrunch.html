<!DOCTYPE html> 
<html> 
	<head> 
	  <meta name="viewport" content="width=device-width, initial-scale=1">
	  
	<title>TechCrunch Mobile</title> 
	<link rel="stylesheet" href="../jquery.mobile/jquery.mobile-1.0b1.min.css" />
	<script type="text/javascript" src="../jquery.mobile/jquery-1.6.1.min.js"></script>
	<script type="text/javascript" src="../jquery.mobile/jquery.mobile-1.0b1.min.js"></script>
</head> 
<body> 

      <div id="home" data-role="page" data-theme="b">
          <div data-role="header">
              <h1>Techcrunch</h1>
              <a href="#info" class="button leftButton flip" data-transition="flip">Info</a>
              <a href="#" class="button icon d-refresh"></a>
          </div>
          <div id="stories" data-role="content">
            <ul data-role="listview" data-theme="g">
            </ul>
          </div>
      </div>
      
      <div id="fullstory" data-role="page">
        <div data-role="header">
            <h1 id="story-title"></h1>
            <a href="#" data-rel="back">Back</a>
        </div>
        <div id="story-content" data-role="content">
        </div>
      </div>
        
      <div id="info" data-role="page">
        <div data-role="header">
            <h1>About</h1>
            <a href="#home" data-rel="back">Back</a>
        </div>
        <div class="info" data-role="content">
          <h2>Techcrunch HTML5 Reader</h2>
        </div>
      </div>
        
      <script src="scrape.js" type="text/javascript"></script>
      <script>
        Storage.prototype.setObject = function(key, value) {
            this.setItem(key, JSON.stringify(value));
        }

        Storage.prototype.getObject = function(key) {
            return JSON.parse(this.getItem(key));
        }
        
        function loadPosts(items) {
          var posts = localStorage.getObject('posts') || [];
          var urls = localStorage.getObject('urls') || {};

          $.each(items.reverse(), function() {
            if (!urls[this.url]) {
              posts.push(this);
              urls[this.url] = 'x';
            }
          });
          localStorage.setObject('urls', urls);
          localStorage.setObject('posts', posts);
          var lastDate = null;
          
          var postsDiv = $('#stories ul');
          
          $.each(posts, function() {
            console.log(this.date + " - " + this.title);
            if (this.date != lastDate) {
              lastDate = this.date;
              postsDiv.append('<li data-role="list-divider">' + this.date + '</li>');
            }
            postsDiv.append('<li><a>' + this.title + '</a></li>');
            var story = this;
            $('#stories ul a:last').click(function() {
              $('#story-title').html(story.title);
              $("#story-content").html(story.body);
              $.mobile.changePage('#fullstory');
            });
          });
          
        }
        
        $(function() {
          loadPosts([]);
          load_tc_home(loadPosts);
        })
        
      </script>


</body>
</html>